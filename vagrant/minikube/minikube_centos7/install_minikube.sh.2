#!/bin/bash

# Mettre à jour le système
sudo yum update -y

# Installer les dépendances nécessaires
sudo yum install -y \
  curl \
  conntrack-tools \
  socat \
  wget \
  jq \
  git \
  vim \
  iproute-tc \
  iputils \
  net-tools \
  docker \
  apt-transport-https \
  ca-certificates \
  lsb-release \
  nfs-utils \
  bridge-utils

# Activer et démarrer Docker
sudo systemctl enable docker
sudo systemctl start docker

# Installer Docker version spécifique (si besoin)
# sudo yum install -y docker-ce-<version>

# Installer kubectl
curl -LO https://dl.k8s.io/release/v1.32.0/bin/linux/amd64/kubectl
chmod +x kubectl
sudo mv kubectl /usr/local/bin/

# Vérifier l'installation de kubectl
kubectl version --client

# Installer kubeadm et kubelet
curl -LO https://dl.k8s.io/release/v1.32.0/bin/linux/amd64/kubeadm
curl -LO https://dl.k8s.io/release/v1.32.0/bin/linux/amd64/kubelet
chmod +x kubeadm kubelet
sudo mv kubeadm kubelet /usr/local/bin/

# Désactiver le swap (nécessaire pour Kubernetes)
sudo swapoff -a
# Pour désactiver le swap définitivement, éditer /etc/fstab et commenter la ligne du swap
sudo sed -i '/ swap / s/^/#/' /etc/fstab

# Ajouter la clé de dépôt Kubernetes
cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg
       https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF

# Installer kubeadm, kubelet et kubectl via le dépôt Kubernetes
sudo yum install -y kubeadm-1.32.0 kubelet-1.32.0 kubectl-1.32.0

# Activer et démarrer kubelet
sudo systemctl enable kubelet
sudo systemctl start kubelet

# Installer Minikube
curl -Lo minikube https://storage.googleapis.com/minikube/releases/v1.35.0/minikube-linux-amd64
chmod +x minikube
sudo mv minikube /usr/local/bin/

# Vérifier l'installation de Minikube
minikube version

# Démarrer Minikube avec le driver "none"
sudo minikube start --kubernetes-version v1.32.0 --driver=none

# Configurer kubectl pour se connecter au cluster Minikube
sudo kubectl config use-context minikube

# Vérifier que le cluster est opérationnel
kubectl get nodes

